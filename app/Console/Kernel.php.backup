<?php

namespace App\Console;

use Illuminate\Console\Scheduling\Schedule;
use Illuminate\Foundation\Console\Kernel as ConsoleKernel;
use App\Jobs\MonitorPositionsJob;
use App\Jobs\GenerateSignalsJob;
use App\Jobs\ExpireSignalsJob;
use App\Jobs\SyncUserBalancesJob;
use App\Jobs\MonitorLimitOrdersJob;
use App\Models\Setting;

class Kernel extends ConsoleKernel
{
    /**
     * Define the application's command schedule.
     */
    protected function schedule(Schedule $schedule): void
    {
        // Load settings with fallbacks
        $signalInterval = (int) Setting::get('signal_interval', 15);
        $tradingEnabled = (bool) Setting::get('trading_enabled', true);
        $monitorInterval = (int) Setting::get('monitor_interval', 1);
        $backupEnabled = (bool) Setting::get('backup_auto_backup', false);
        $backupFrequency = Setting::get('backup_frequency', 'daily');
        $dataRetentionDays = (int) Setting::get('backup_data_retention', 365);
        $logRetentionDays = (int) Setting::get('backup_log_retention', 90);
        $dailySummaryEnabled = (bool) Setting::get('notifications_daily_summary', true);

        // ==========================================
        // CRITICAL: Monitor Limit Orders (Every 2 Minutes)
        // ==========================================
        
        $schedule->job(new MonitorLimitOrdersJob)
            ->everyTwoMinutes()
            ->name('monitor-limit-orders')
            ->withoutOverlapping(2)
            ->onOneServer();

        // ==========================================
        // CRITICAL: Position Monitoring
        // ==========================================
        
        if ($tradingEnabled) {
            if ($monitorInterval <= 1) {
                $schedule->job(new MonitorPositionsJob)
                    ->everyMinute()
                    ->name('monitor-positions')
                    ->withoutOverlapping(5);
            } else {
                $schedule->job(new MonitorPositionsJob)
                    ->cron("*/{$monitorInterval} * * * *")
                    ->name('monitor-positions')
                    ->withoutOverlapping(5);
            }
        }

        // ==========================================
        // Signal Generation
        // ==========================================
        
        if ($tradingEnabled) {
            $schedule->job(new GenerateSignalsJob)
                ->cron("*/{$signalInterval} * * * *")
                ->name('generate-signals')
                ->withoutOverlapping(10);
        }

        // ==========================================
        // Signal Expiration Check (Every 5 Minutes)
        // ==========================================
        
        $schedule->job(new ExpireSignalsJob)
            ->everyFiveMinutes()
            ->name('expire-signals');

        // ==========================================
        // Balance Synchronization (Every 30 Minutes)
        // ==========================================
        
        if ($tradingEnabled) {
            $schedule->job(new SyncUserBalancesJob)
                ->everyThirtyMinutes()
                ->name('sync-balances')
                ->withoutOverlapping(5);
        }

        // ==========================================
        // Daily Statistics & Reports
        // ==========================================
        
        $schedule->call(function () {
            \Artisan::call('app:calculate-user-stats');
        })
            ->dailyAt('00:05')
            ->name('calculate-daily-stats');

        if ($dailySummaryEnabled) {
            $schedule->call(function () {
                \Artisan::call('app:send-daily-reports');
            })
                ->dailyAt('08:00')
                ->name('send-daily-reports');
        }

        // ==========================================
        // Maintenance & Cleanup Tasks
        // ==========================================

        // Clean up expired signals
        $schedule->call(function () {
            $deleted = \DB::table('signals')
                ->where('status', 'expired')
                ->where('created_at', '<', now()->subDay())
                ->delete();
                
            if ($deleted > 0) {
                \Log::info("Cleaned up {$deleted} expired signals");
            }
        })
            ->daily()
            ->at('02:00')
            ->name('cleanup-expired-signals');

        // Clean up old closed trades
        $schedule->call(function () use ($dataRetentionDays) {
            $deleted = \DB::table('trades')
                ->where('status', 'closed')
                ->where('closed_at', '<', now()->subDays($dataRetentionDays))
                ->delete();
                
            if ($deleted > 0) {
                \Log::info("Archived {$deleted} old trades (retention: {$dataRetentionDays} days)");
            }
        })
            ->weekly()
            ->sundays()
            ->at('03:00')
            ->name('archive-old-trades');

        // Clean up failed jobs
        $schedule->command('queue:flush')
            ->weekly()
            ->name('cleanup-failed-jobs');

        // Clean up old log files
        $schedule->call(function () use ($logRetentionDays) {
            $logPath = storage_path('logs');
            $files = glob($logPath . '/*.gz');
            
            $deleted = 0;
            foreach ($files as $file) {
                if (filemtime($file) < strtotime("-{$logRetentionDays} days")) {
                    unlink($file);
                    $deleted++;
                }
            }
            
            if ($deleted > 0) {
                \Log::info("Deleted {$deleted} old log files (retention: {$logRetentionDays} days)");
            }
        })
            ->weekly()
            ->name('delete-old-logs');

        // Prune telescope if installed
        if (class_exists(\Laravel\Telescope\Telescope::class)) {
            $schedule->command('telescope:prune --hours=168')
                ->daily()
                ->name('prune-telescope');
        }

        // ==========================================
        // Database Backup
        // ==========================================
        
        if ($backupEnabled) {
            $backupJob = $schedule->call(function () {
                \Artisan::call('backup:run');
            })->name('database-backup');

            match ($backupFrequency) {
                'hourly' => $backupJob->hourly(),
                'daily' => $backupJob->dailyAt('01:00'),
                'weekly' => $backupJob->weekly()->sundays()->at('01:00'),
                'monthly' => $backupJob->monthly(),
                default => $backupJob->dailyAt('01:00'),
            };
        }

        // ==========================================
        // Health Checks & Monitoring
        // ==========================================

        $schedule->call(function () {
            if (!Setting::get('trading_enabled', true)) {
                return;
            }
            
            // Check for stuck positions
            $stuckPositions = \DB::table('positions')
                ->where('is_active', true)
                ->where('last_updated_at', '<', now()->subHours(2))
                ->count();
                
            if ($stuckPositions > 0) {
                \Log::error("Found {$stuckPositions} stuck positions");
            }
            
            // Check for failed API connections
            $failedAccounts = \DB::table('exchange_accounts')
                ->where('is_active', true)
                ->where('last_synced_at', '<', now()->subHours(1))
                ->count();
                
            if ($failedAccounts > 0) {
                \Log::warning("{$failedAccounts} exchange accounts haven't synced in 1+ hour");
            }
        })
            ->everyFifteenMinutes()
            ->name('system-health-check');

        // Monitor queue size
        $schedule->call(function () {
            $queueSize = \DB::table('jobs')->count();
            $failedJobs = \DB::table('failed_jobs')->whereDate('failed_at', today())->count();
            
            if ($queueSize > 1000) {
                \Log::warning("Queue size is high: {$queueSize} jobs pending");
            }
            
            if ($failedJobs > 50) {
                \Log::error("High number of failed jobs today: {$failedJobs}");
            }
        })
            ->everyTenMinutes()
            ->name('queue-monitoring');

        // ==========================================
        // Circuit Breaker Check
        // ==========================================
        
        if (Setting::get('monitor_circuit_breaker', true)) {
            $schedule->call(function () {
                $dailyLossLimit = (float) Setting::get('monitor_daily_loss_limit', 15);
                
                $dailyLoss = \DB::table('trades')
                    ->where('status', 'closed')
                    ->whereDate('closed_at', today())
                    ->sum('realized_pnl');
                    
                $totalBalance = \DB::table('exchange_accounts')
                    ->where('is_active', true)
                    ->sum('balance');
                    
                if ($totalBalance > 0) {
                    $lossPercent = abs($dailyLoss / $totalBalance) * 100;
                    
                    if ($dailyLoss < 0 && $lossPercent >= $dailyLossLimit) {
                        \Log::critical("CIRCUIT BREAKER: Daily loss limit reached ({$lossPercent}% loss)");
                        Setting::set('trading_enabled', false);
                    }
                }
            })
                ->everyThirtyMinutes()
                ->name('circuit-breaker-check');
        }

        // ==========================================
        // Log Rotation
        // ==========================================
        
        $schedule->call(function () {
            $logPath = storage_path('logs');
            $files = glob($logPath . '/laravel-*.log');
            
            $compressed = 0;
            foreach ($files as $file) {
                if (filemtime($file) < strtotime('-7 days')) {
                    exec("gzip {$file}");
                    $compressed++;
                }
            }
            
            if ($compressed > 0) {
                \Log::info("Compressed {$compressed} old log files");
            }
        })
            ->weekly()
            ->name('compress-logs');
    }

    /**
     * Register the commands for the application.
     */
    protected function commands(): void
    {
        $this->load(__DIR__.'/Commands');
        require base_path('routes/console.php');
    }

    /**
     * Get the timezone that should be used by default for scheduled events.
     */
    protected function scheduleTimezone(): string
    {
        return config('app.timezone', 'UTC');
    }
}